package net.CSC4111.ourApp.WSUSocial.ui;
import android.content.Intent;import android.os.Bundle;import androidx.annotation.NonNull;import androidx.appcompat.app.AppCompatActivity;import android.text.TextUtils;import android.view.View;import android.widget.Button;import android.widget.EditText;import android.widget.ProgressBar;import android.widget.Toast;import com.google.android.gms.tasks.OnCompleteListener;import com.google.android.gms.tasks.Task;import com.google.firebase.auth.AuthResult;import com.google.firebase.auth.FirebaseAuth;import com.google.firebase.auth.FirebaseUser;import com.google.firebase.database.DatabaseReference;import com.google.firebase.database.FirebaseDatabase;import net.CSC4111.ourApp.WSUSocial.R;import net.CSC4111.ourApp.WSUSocial.models.User;import static net.CSC4111.ourApp.WSUSocial.Const.USERS;

public class RegisterActivity extends AppCompatActivity{private static final String AT_SYMBOL = "@";public static final int MIN_PASSWRD_LENGTH = 6;private static final int ZERO_VALUE = 0;private EditText mInputEmail, mInputPassword;private Button mBtnSignIn, mBtnRegister;private ProgressBar mProgressBar;private FirebaseAuth mAuth;private DatabaseReference mDatabase;
    @Override
    protected void onCreate(Bundle savedInstanceState){super.onCreate(savedInstanceState);setContentView(R.layout.activity_register);initializeFirebase();findViews();setOnClickMethods();}
    private void initializeFirebase(){mAuth = FirebaseAuth.getInstance();mDatabase = FirebaseDatabase.getInstance().getReference();}
    private void setOnClickMethods(){
        mBtnSignIn.setOnClickListener(new View.OnClickListener(){
            @Override
            public void onClick(View v){finish();}});mBtnRegister.setOnClickListener(new View.OnClickListener(){
            @Override
            public void onClick(View v){String email = mInputEmail.getText().toString().trim();String password = mInputPassword.getText().toString().trim();if(TextUtils.isEmpty(email)){mInputEmail.setError(getString(R.string.error_toast_enter_email));Toast.makeText(getApplicationContext(),getString(R.string.error_toast_enter_email),Toast.LENGTH_SHORT).show();return;}if(!android.util.Patterns.EMAIL_ADDRESS.matcher(mInputEmail.getText().toString()).matches()){mInputEmail.setError(getString(R.string.wrong_email_format));return;}if (TextUtils.isEmpty(password)){Toast.makeText(getApplicationContext(),getString(R.string.error_toast_enter_password),Toast.LENGTH_SHORT).show();return;}if(password.length() < MIN_PASSWRD_LENGTH){Toast.makeText(getApplicationContext(),getString(R.string.error_toast_short_password),Toast.LENGTH_SHORT).show();return;}mProgressBar.setVisibility(View.VISIBLE);mBtnSignIn.setEnabled(false);mBtnRegister.setEnabled(false);mAuth.createUserWithEmailAndPassword(email, password).addOnCompleteListener(RegisterActivity.this, new OnCompleteListener<AuthResult>(){
                            @Override
                            public void onComplete(@NonNull Task<AuthResult> task){String result = getString(R.string.toast_auth_completed) + task.isSuccessful();Toast.makeText(RegisterActivity.this,result,Toast.LENGTH_SHORT).show();mProgressBar.setVisibility(View.GONE);mBtnSignIn.setClickable(true);mBtnRegister.setClickable(true);if (!task.isSuccessful()){result = getString(R.string.error_toast_auth_failed) + task.getException();mInputEmail.setError(getString(R.string.error_toast_auth_failed));Toast.makeText(RegisterActivity.this,result,Toast.LENGTH_SHORT).show();}else{onAuthSuccess(task.getResult().getUser());}}});}});}
    private void onAuthSuccess(FirebaseUser user){String username = usernameFromEmail(user.getEmail());writeNewUser(user.getUid(), username, user.getEmail());startActivity(new Intent(RegisterActivity.this, MainActivity.class));finish();}
    private String usernameFromEmail(String email){if(email.contains(AT_SYMBOL)){return email.split(AT_SYMBOL)[ZERO_VALUE];}else{return email;}}
    private void writeNewUser(String userId, String name, String email){User user = new User(name, email);mDatabase.child(USERS).child(userId).setValue(user);}
    private void findViews(){mBtnSignIn = (Button) findViewById(R.id.btn_sign_in);mBtnRegister = (Button) findViewById(R.id.btn_register);mInputEmail = (EditText) findViewById(R.id.email);mInputPassword = (EditText) findViewById(R.id.password);mProgressBar = (ProgressBar) findViewById(R.id.progress_bar);}
    @Override
    protected void onResume(){super.onResume();mProgressBar.setVisibility(View.GONE);mBtnSignIn.setClickable(true);mBtnRegister.setClickable(true);}}